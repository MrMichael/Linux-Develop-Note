[TOC]

Reference: [Kubernetes æ–‡æ¡£](https://kubernetes.io/zh/docs/home/)



## ä¸€ã€ç®€ä»‹

â€‹	Kubernetes æ˜¯ä¸€ä¸ªå¯ç§»æ¤çš„ï¼Œå¯æ‰©å±•çš„å¼€æºå¹³å°ï¼Œç”¨äºç®¡ç†å®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½å’ŒæœåŠ¡ï¼Œæ–¹ä¾¿äº†å£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åŒ–ã€‚è¯¥ç³»ç»Ÿç”±Googleè®¾è®¡å¹¶æèµ ç»™Cloud Native Computing Foundationï¼ˆä»Šå±[LinuxåŸºé‡‘ä¼š](https://zh.wikipedia.org/wiki/LinuxåŸºé‡‘ä¼š)ï¼‰æ¥ä½¿ç”¨ã€‚å®ƒæ—¨åœ¨æä¾›â€œè·¨ä¸»æœºé›†ç¾¤çš„è‡ªåŠ¨éƒ¨ç½²ã€æ‰©å±•ä»¥åŠè¿è¡Œåº”ç”¨ç¨‹åºå®¹å™¨çš„å¹³å°â€ã€‚å®ƒæ”¯æŒä¸€ç³»åˆ—å®¹å™¨å·¥å…·, åŒ…æ‹¬[Docker](https://zh.wikipedia.org/wiki/Docker_(è»Ÿé«”))ç­‰ã€‚



### 1.åº”ç”¨ç¨‹åºéƒ¨ç½²çš„å‘å±•è¿‡ç¨‹

![](https://d33wubrfki0l68.cloudfront.net/26a177ede4d7b032362289c6fccd448fc4a91174/eb693/images/docs/container_evolution.svg)

- **ä¼ ç»Ÿéƒ¨ç½²æ—¶ä»£ï¼š** æ—©æœŸï¼Œç»„ç»‡åœ¨ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºã€‚æ— æ³•ä¸ºç‰©ç†æœåŠ¡å™¨ä¸­çš„åº”ç”¨ç¨‹åºå®šä¹‰èµ„æºè¾¹ç•Œï¼Œè¿™ä¼šå¯¼è‡´èµ„æºåˆ†é…é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªåº”ç”¨ç¨‹åºå ç”¨å¤§éƒ¨åˆ†èµ„æºçš„æƒ…å†µï¼Œç»“æœå¯èƒ½å¯¼è‡´å…¶ä»–åº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¸‹é™ã€‚

- **è™šæ‹ŸåŒ–éƒ¨ç½²æ—¶ä»£ï¼š** ä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œå¼•å…¥äº†è™šæ‹ŸåŒ–åŠŸèƒ½ï¼Œå®ƒå…è®¸æ‚¨åœ¨å•ä¸ªç‰©ç†æœåŠ¡å™¨çš„ CPU ä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼ˆVMï¼‰ã€‚è™šæ‹ŸåŒ–åŠŸèƒ½å…è®¸åº”ç”¨ç¨‹åºåœ¨ VM ä¹‹é—´éš”ç¦»ï¼Œå¹¶æä¾›å®‰å…¨çº§åˆ«ï¼Œå› ä¸ºä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ä¿¡æ¯ä¸èƒ½è¢«å¦ä¸€åº”ç”¨ç¨‹åºè‡ªç”±åœ°è®¿é—®ã€‚

  - å› ä¸ºè™šæ‹ŸåŒ–å¯ä»¥è½»æ¾åœ°æ·»åŠ æˆ–æ›´æ–°åº”ç”¨ç¨‹åºã€é™ä½ç¡¬ä»¶æˆæœ¬ç­‰ç­‰ï¼Œæ‰€ä»¥è™šæ‹ŸåŒ–å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨ç‰©ç†æœåŠ¡å™¨ä¸­çš„èµ„æºï¼Œå¹¶å¯ä»¥å®ç°æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ã€‚

  - æ¯ä¸ª VM æ˜¯ä¸€å°å®Œæ•´çš„è®¡ç®—æœºï¼Œåœ¨è™šæ‹ŸåŒ–ç¡¬ä»¶ä¹‹ä¸Šè¿è¡Œæ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬å…¶è‡ªå·±çš„æ“ä½œç³»ç»Ÿã€‚

- **å®¹å™¨éƒ¨ç½²æ—¶ä»£ï¼š** Containerï¼ˆå®¹å™¨ï¼‰æ˜¯ä¸€ç§ä¾¿æºå¼ã€è½»é‡çº§çš„æ“ä½œç³»ç»Ÿçº§è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚å®ƒä½¿ç”¨ namespace éš”ç¦»ä¸åŒçš„è½¯ä»¶è¿è¡Œç¯å¢ƒï¼Œå¹¶é€šè¿‡é•œåƒè‡ªåŒ…å«è½¯ä»¶çš„è¿è¡Œç¯å¢ƒï¼Œè€Œåº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰ï¼Œä»è€Œä½¿å¾—å®¹å™¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œã€‚å®¹å™¨ä¸ VM ç±»ä¼¼ï¼Œå…·æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜ã€è¿›ç¨‹ç©ºé—´ç­‰ã€‚ç”±äºå®ƒä»¬ä¸åŸºç¡€æ¶æ„åˆ†ç¦»ï¼Œå› æ­¤å¯ä»¥è·¨äº‘å’Œ OS åˆ†å‘è¿›è¡Œç§»æ¤ã€‚



### 2.å®¹å™¨åŒ–éƒ¨ç½²çš„ä¼˜ç‚¹

- æ•æ·åº”ç”¨ç¨‹åºçš„åˆ›å»ºå’Œéƒ¨ç½²ï¼šä¸ä½¿ç”¨ VM é•œåƒç›¸æ¯”ï¼Œæé«˜äº†å®¹å™¨é•œåƒåˆ›å»ºçš„ç®€ä¾¿æ€§å’Œæ•ˆç‡ã€‚
- æŒç»­å¼€å‘ã€é›†æˆå’Œéƒ¨ç½²ï¼šé€šè¿‡å¿«é€Ÿç®€å•çš„å›æ»š(ç”±äºé•œåƒä¸å¯å˜æ€§)ï¼Œæä¾›å¯é ä¸”é¢‘ç¹çš„å®¹å™¨é•œåƒæ„å»ºå’Œéƒ¨ç½²ã€‚
- å…³æ³¨å¼€å‘ä¸è¿ç»´çš„åˆ†ç¦»ï¼šåœ¨æ„å»º/å‘å¸ƒæ—¶è€Œä¸æ˜¯åœ¨éƒ¨ç½²æ—¶åˆ›å»ºåº”ç”¨ç¨‹åºå®¹å™¨é•œåƒï¼Œä»è€Œå°†åº”ç”¨ç¨‹åºä¸åŸºç¡€æ¶æ„åˆ†ç¦»ã€‚
- å¯è§‚å¯Ÿæ€§ä¸ä»…å¯ä»¥æ˜¾ç¤ºæ“ä½œç³»ç»Ÿçº§åˆ«çš„ä¿¡æ¯å’ŒæŒ‡æ ‡ï¼Œè¿˜å¯ä»¥æ˜¾ç¤ºåº”ç”¨ç¨‹åºçš„è¿è¡ŒçŠ¶å†µå’Œå…¶ä»–æŒ‡æ ‡ä¿¡å·ã€‚
- è·¨å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§çš„ç¯å¢ƒä¸€è‡´æ€§ï¼šåœ¨ä¾¿æºå¼è®¡ç®—æœºä¸Šä¸åœ¨äº‘ä¸­ç›¸åŒåœ°è¿è¡Œã€‚
- äº‘å’Œæ“ä½œç³»ç»Ÿåˆ†å‘çš„å¯ç§»æ¤æ€§ï¼šå¯åœ¨ Ubuntuã€RHELã€CoreOSã€æœ¬åœ°ã€Google Kubernetes Engine å’Œå…¶ä»–ä»»ä½•åœ°æ–¹è¿è¡Œã€‚
- ä»¥åº”ç”¨ç¨‹åºä¸ºä¸­å¿ƒçš„ç®¡ç†ï¼šæé«˜æŠ½è±¡çº§åˆ«ï¼Œä»åœ¨è™šæ‹Ÿç¡¬ä»¶ä¸Šè¿è¡Œ OS åˆ°ä½¿ç”¨é€»è¾‘èµ„æºåœ¨ OS ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºã€‚
- æ¾æ•£è€¦åˆã€åˆ†å¸ƒå¼ã€å¼¹æ€§ã€è§£æ”¾çš„å¾®æœåŠ¡ï¼šåº”ç”¨ç¨‹åºè¢«åˆ†è§£æˆè¾ƒå°çš„ç‹¬ç«‹éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥åŠ¨æ€éƒ¨ç½²å’Œç®¡ç† - è€Œä¸æ˜¯åœ¨ä¸€å°å¤§å‹å•æœºä¸Šæ•´ä½“è¿è¡Œã€‚
- èµ„æºéš”ç¦»ï¼šå¯é¢„æµ‹çš„åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚
- èµ„æºåˆ©ç”¨ï¼šé«˜æ•ˆç‡å’Œé«˜å¯†åº¦ã€‚



### 3.Kubernetesçš„ç‰¹æ€§

â€‹	åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦ç®¡ç†è¿è¡Œåº”ç”¨ç¨‹åºçš„å®¹å™¨ï¼Œå¹¶ç¡®ä¿ä¸ä¼šåœæœºã€‚Kubernetes åˆ™æä¾›ä¸€ä¸ªå¯å¼¹æ€§è¿è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¡†æ¶ï¼Œæ»¡è¶³æ‰©å±•è¦æ±‚ã€æ•…éšœè½¬ç§»ã€éƒ¨ç½²æ¨¡å¼ç­‰éœ€æ±‚ã€‚ä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š

- **æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡**

  Kubernetes å¯ä»¥é€šè¿‡ DNS åç§°æˆ– IP åœ°å€æš´éœ²å®¹å™¨çš„è®¿é—®æ–¹å¼ã€‚å¹¶ä¸”å¯ä»¥åœ¨åŒç»„å®¹å™¨å†…åˆ†å‘è´Ÿè½½ä»¥å®ç°è´Ÿè½½å‡è¡¡

- **å­˜å‚¨ç¼–æ’**

  Kuberneteså¯ä»¥è‡ªåŠ¨æŒ‚è½½æŒ‡å®šçš„å­˜å‚¨ç³»ç»Ÿï¼Œä¾‹å¦‚ local stroage/nfs/äº‘å­˜å‚¨ç­‰

- **è‡ªåŠ¨å‘å¸ƒå’Œå›æ»š**

  æ‚¨å¯ä»¥åœ¨ Kubernetes ä¸­å£°æ˜æ‚¨æœŸæœ›åº”ç”¨ç¨‹åºå®¹å™¨åº”è¯¥è¾¾åˆ°çš„çŠ¶æ€ï¼ŒKuberneteså°†ä»¥åˆé€‚çš„é€Ÿç‡è°ƒæ•´å®¹å™¨çš„å®é™…çŠ¶æ€ï¼Œå¹¶é€æ­¥è¾¾åˆ°æœ€ç»ˆæœŸæœ›çš„ç»“æœã€‚

- **è‡ªæ„ˆ**

  Kubernetesæä¾›å¦‚ä¸‹è‡ªæ„ˆèƒ½åŠ›ï¼š

  - é‡å¯å·²ç»åœæœºçš„å®¹å™¨
  - æ›¿æ¢ã€kill é‚£äº›ä¸æ»¡è¶³è‡ªå®šä¹‰å¥åº·æ£€æŸ¥æ¡ä»¶çš„å®¹å™¨
  - åœ¨å®¹å™¨å°±ç»ªä¹‹å‰ï¼Œé¿å…è°ƒç”¨è€…å‘ç°è¯¥å®¹å™¨

- **å¯†é’¥åŠé…ç½®ç®¡ç†**

  Kuberneteså¯ä»¥å­˜å‚¨å’Œç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œå¯†ç ã€OAuth tokenã€sshå¯†é’¥ç­‰ï¼‰ã€‚æ‚¨å¯ä»¥æ›´æ–°å®¹å™¨åº”ç”¨ç¨‹åºçš„å¯†é’¥ã€é…ç½®ç­‰ä¿¡æ¯ï¼Œè€Œæ— éœ€ï¼š

  - é‡æ–°æ„å»ºå®¹å™¨çš„é•œåƒ
  - åœ¨ä¸åˆé€‚çš„åœ°æ–¹æš´éœ²å¯†ç ä¿¡æ¯



### 4.Kubernetesçš„æ¦‚å¿µ

#### 1ï¼‰Pod

Kubernetes ä½¿ç”¨ Pod æ¥ç®¡ç†å®¹å™¨ï¼Œæ¯ä¸ª Pod å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†å…³è”çš„å®¹å™¨ï¼ˆdocker containerï¼‰ï¼Œå®ƒä»¬å…±äº« PIDã€IPCã€Network å’Œ UTS namespaceï¼Œæ˜¯ Kubernetes è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚

Pod å†…çš„å¤šä¸ªå®¹å™¨å…±äº«ç½‘ç»œå’Œæ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡è¿›ç¨‹é—´é€šä¿¡å’Œæ–‡ä»¶å…±äº«è¿™ç§ç®€å•é«˜æ•ˆçš„æ–¹å¼ç»„åˆå®ŒæˆæœåŠ¡ã€‚

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/introduction/media/pod.png)

#### 2ï¼‰å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰

å®¹å™¨è¿è¡Œæ—¶æ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶ã€‚Kubernetes æ”¯æŒå¤šä¸ªå®¹å™¨è¿è¡Œç¯å¢ƒ: [Docker](http://www.docker.com/)ã€ [containerd](https://containerd.io/)ã€[cri-o](https://cri-o.io/)ã€ [rktlet](https://github.com/kubernetes-incubator/rktlet) ä»¥åŠä»»ä½•å®ç° [Kubernetes CRI (å®¹å™¨è¿è¡Œç¯å¢ƒæ¥å£)](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md)ã€‚



#### 3ï¼‰Node

Node æ˜¯ Pod çœŸæ­£è¿è¡Œçš„ä¸»æœºï¼Œå¯ä»¥æ˜¯ç‰©ç†æœºï¼Œä¹Ÿå¯ä»¥æ˜¯è™šæ‹Ÿæœºã€‚ä¸ºäº†ç®¡ç† Podï¼Œæ¯ä¸ª Node èŠ‚ç‚¹ä¸Šè‡³å°‘è¦è¿è¡Œ container runtimeï¼ˆæ¯”å¦‚ docker æˆ–è€… rktï¼‰ã€`kubelet` å’Œ `kube-proxy` æœåŠ¡ã€‚

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/introduction/media/node.png)

#### 4ï¼‰Kubernetes é›†ç¾¤

ä¸€ä¸ª Kubernetes é›†ç¾¤ç”±åˆ†å¸ƒå¼å­˜å‚¨ etcdã€æ§åˆ¶èŠ‚ç‚¹ controller ä»¥åŠæœåŠ¡èŠ‚ç‚¹ Node ç»„æˆã€‚

- æ§åˆ¶èŠ‚ç‚¹ä¸»è¦è´Ÿè´£æ•´ä¸ªé›†ç¾¤çš„ç®¡ç†ï¼Œæ¯”å¦‚å®¹å™¨çš„è°ƒåº¦ã€ç»´æŠ¤èµ„æºçš„çŠ¶æ€ã€è‡ªåŠ¨æ‰©å±•ä»¥åŠæ»šåŠ¨æ›´æ–°ç­‰
- æœåŠ¡èŠ‚ç‚¹æ˜¯çœŸæ­£è¿è¡Œå®¹å™¨çš„ä¸»æœºï¼Œè´Ÿè´£ç®¡ç†é•œåƒå’Œå®¹å™¨ä»¥åŠ cluster å†…çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
- etcd é›†ç¾¤ä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€



#### 5ï¼‰Namespace

Namespaceï¼Œé¡¾åæ€ä¹‰ï¼Œä¸ºä¸åŒçš„è¿›ç¨‹é›†åˆæä¾›ä¸åŒçš„ã€Œå‘½åç©ºé—´ã€ï¼Œä¸åŒè¿›ç¨‹é›†åˆå½¼æ­¤ä¸èƒ½è®¿é—®å…¶å¯¹åº”çš„ã€Œå‘½åç©ºé—´ã€ï¼Œè€Œã€Œå‘½åç©ºé—´ã€å…¶å®å°±æ˜¯å…¶èµ„æºé›†åˆï¼Œå®ƒæ˜¯ Linux å†…æ ¸ç”¨æ¥éš”ç¦»å†…æ ¸èµ„æºçš„æ–¹å¼ã€‚

- ä¾‹å¦‚ï¼šè¿›ç¨‹ A å’Œè¿›ç¨‹ B åˆ†åˆ«å±äºä¸¤ä¸ªä¸åŒçš„ Namespaceï¼Œé‚£ä¹ˆè¿›ç¨‹ A å°†å¯ä»¥ä½¿ç”¨ Linux å†…æ ¸æä¾›çš„æ‰€æœ‰ Namespace èµ„æºï¼šå¦‚ç‹¬ç«‹çš„ä¸»æœºåï¼Œç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç‹¬ç«‹çš„è¿›ç¨‹ç¼–å·ç­‰ç­‰ã€‚åŒæ ·åœ°ï¼Œè¿›ç¨‹ B ä¹Ÿå¯ä»¥ä½¿ç”¨åŒç±»èµ„æºï¼Œä½†å…¶èµ„æºä¸è¿›ç¨‹ A ä½¿ç”¨çš„èµ„æºç›¸äº’éš”ç¦»ï¼Œå½¼æ­¤æ— æ³•æ„ŸçŸ¥ã€‚

Linux å†…æ ¸æä¾›äº†[ 7 ç§ä¸åŒçš„ Namespace](http://man7.org/linux/man-pages/man7/namespaces.7.html)ï¼Œç”±å¸¦æœ‰CLONE_NEW*æ ‡å¿—çš„clone()æ‰€åˆ›å»ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

- å‰å…­ç§ namespace æ­£æ˜¯å®ç°å®¹å™¨å¿…é¡»çš„éš”ç¦»æŠ€æœ¯ï¼Œè‡³äºæ–°æä¾›çš„ Cgroup namespace ç›®å‰è¿˜æ²¡æœ‰è¢« docker é‡‡ç”¨

| Namespace | `clone()` ä½¿ç”¨çš„ flag | æ‰€éš”ç¦»çš„èµ„æº                 |
| --------- | --------------------- | ---------------------------- |
| IPC       | `CLONE_NEWIPC`        | System V IPCï¼ŒPOSIX æ¶ˆæ¯é˜Ÿåˆ— |
| Network   | `CLONE_NEWNET`        | ç½‘ç»œè®¾å¤‡ã€åè®®æ ˆã€ç«¯å£ç­‰     |
| Mount     | `CLONE_NEWNS`         | æŒ‚è½½ç‚¹                       |
| PID       | `CLONE_NEWPID`        | è¿›ç¨‹ ID                      |
| User      | `CLONE_NEWUSER`       | ç”¨æˆ·å’Œç»„ ID                  |
| UTS       | `CLONE_NEWUTS`        | ä¸»æœºåå’ŒåŸŸå                 |
| Cgroup    | `CLONE_NEWCGROUP`     | Cgroup æ ¹ç›®å½•                |

ç”¨æˆ·å¯ä»¥åœ¨`/proc/$pid/ns`æ–‡ä»¶ä¸‹çœ‹åˆ°æœ¬è¿›ç¨‹æ‰€å±çš„`Namespace`çš„æ–‡ä»¶ä¿¡æ¯ã€‚ä¾‹å¦‚PIDä¸º2704è¿›ç¨‹çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://pic3.zhimg.com/80/v2-a7cec63ec33dd60377cf4d37bd94d5b4_720w.jpg)

- å…¶ä¸­ 4026531839 è¡¨æ˜æ˜¯`Namespace`çš„IDï¼Œå¦‚æœä¸¤ä¸ªè¿›ç¨‹çš„`Namespace` IDç›¸åŒè¡¨æ˜ä¸¤ä¸ªè¿›ç¨‹åŒå¤„äºä¸€ä¸ªå‘½åç©ºé—´ä¸­ã€‚
- å³ä½¿ namespace ä¸­çš„è¿›ç¨‹å…¨éƒ¨ç»ˆç»“äº†ï¼Œåªè¦å…¶è½¯é“¾æ¥æ–‡ä»¶ä¸€ç›´å¤„äº open çŠ¶æ€ï¼Œåˆ™ namespace å°†ä¸€ç›´å­˜åœ¨ï¼›



#### 6ï¼‰Service

Service æ˜¯åº”ç”¨æœåŠ¡çš„æŠ½è±¡ï¼Œé€šè¿‡ labels ä¸ºåº”ç”¨æä¾›è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡å‘ç°ã€‚åŒ¹é… labels çš„ Pod IP å’Œç«¯å£åˆ—è¡¨ç»„æˆ endpointsï¼Œç”± kube-proxy è´Ÿè´£å°†æœåŠ¡ IP è´Ÿè½½å‡è¡¡åˆ°è¿™äº› endpoints ä¸Šã€‚

æ¯ä¸ª Service éƒ½ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ª cluster IPï¼ˆä»…åœ¨é›†ç¾¤å†…éƒ¨å¯è®¿é—®çš„è™šæ‹Ÿåœ°å€ï¼‰å’Œ DNS åï¼Œå…¶ä»–å®¹å™¨å¯ä»¥é€šè¿‡è¯¥åœ°å€æˆ– DNS æ¥è®¿é—®æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åç«¯å®¹å™¨çš„è¿è¡Œã€‚

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/introduction/media/14731220608865.png)



#### 7ï¼‰Label

Label æ˜¯è¯†åˆ« Kubernetes å¯¹è±¡çš„æ ‡ç­¾ï¼Œä»¥ key/value çš„æ–¹å¼é™„åŠ åˆ°å¯¹è±¡ä¸Šï¼ˆkey æœ€é•¿ä¸èƒ½è¶…è¿‡ 63 å­—èŠ‚ï¼Œvalue å¯ä»¥ä¸ºç©ºï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸è¶…è¿‡ 253 å­—èŠ‚çš„å­—ç¬¦ä¸²ï¼‰ã€‚

Label ä¸æä¾›å”¯ä¸€æ€§ï¼Œå¹¶ä¸”å®é™…ä¸Šç»å¸¸æ˜¯å¾ˆå¤šå¯¹è±¡ï¼ˆå¦‚ Podsï¼‰éƒ½ä½¿ç”¨ç›¸åŒçš„ label æ¥æ ‡å¿—å…·ä½“çš„åº”ç”¨ã€‚

Label å®šä¹‰å¥½åå…¶ä»–å¯¹è±¡å¯ä»¥ä½¿ç”¨ Label Selector æ¥é€‰æ‹©ä¸€ç»„ç›¸åŒ label çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ ReplicaSet å’Œ Service ç”¨ label æ¥é€‰æ‹©ä¸€ç»„ Podï¼‰ã€‚Label Selector æ”¯æŒä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

- ç­‰å¼ï¼Œå¦‚ `app=nginx` å’Œ `env!=production`
- é›†åˆï¼Œå¦‚ `env in (production, qa)`
- å¤šä¸ª labelï¼ˆå®ƒä»¬ä¹‹é—´æ˜¯ AND å…³ç³»ï¼‰ï¼Œå¦‚ `app=nginx,env=test`



#### 8ï¼‰Annotations

Annotations æ˜¯ key/value å½¢å¼é™„åŠ äºå¯¹è±¡çš„æ³¨è§£ã€‚ä¸åŒäº Labels ç”¨äºæ ‡å¿—å’Œé€‰æ‹©å¯¹è±¡ï¼ŒAnnotations åˆ™æ˜¯ç”¨æ¥è®°å½•ä¸€äº›é™„åŠ ä¿¡æ¯ï¼Œç”¨æ¥è¾…åŠ©åº”ç”¨éƒ¨ç½²ã€å®‰å…¨ç­–ç•¥ä»¥åŠè°ƒåº¦ç­–ç•¥ç­‰ã€‚æ¯”å¦‚ deployment ä½¿ç”¨ annotations æ¥è®°å½• rolling update çš„çŠ¶æ€ã€‚





## äºŒã€Kubernetes æ ¸å¿ƒåŸç†

### 1.Kubernetes æ¶æ„

Kubernetes æœ€åˆæºäºè°·æ­Œå†…éƒ¨çš„ Borgï¼Œæä¾›äº†é¢å‘åº”ç”¨çš„å®¹å™¨é›†ç¾¤éƒ¨ç½²å’Œç®¡ç†ç³»ç»Ÿã€‚Kubernetes å€Ÿé‰´äº† Borg çš„è®¾è®¡ç†å¿µï¼Œæ¯”å¦‚ Podã€Serviceã€Labels å’Œå• Pod å• IP ç­‰ã€‚Kubernetes çš„æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/architecture/images/architecture.png)

![](https://static.bookstack.cn/projects/kubernetes-handbook/41619819a2227a760432a390d909f0ea.jpeg)



#### 1ï¼‰åˆ†å±‚æ¶æ„

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/architecture/images/14937095836427.jpg)

- æ ¸å¿ƒå±‚ï¼šKubernetes æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œå¯¹å¤–æä¾› API æ„å»ºé«˜å±‚çš„åº”ç”¨ï¼Œå¯¹å†…æä¾›æ’ä»¶å¼åº”ç”¨æ‰§è¡Œç¯å¢ƒ
- åº”ç”¨å±‚ï¼šéƒ¨ç½²ï¼ˆæ— çŠ¶æ€åº”ç”¨ã€æœ‰çŠ¶æ€åº”ç”¨ã€æ‰¹å¤„ç†ä»»åŠ¡ã€é›†ç¾¤åº”ç”¨ç­‰ï¼‰å’Œè·¯ç”±ï¼ˆæœåŠ¡å‘ç°ã€DNS è§£æç­‰ï¼‰
- ç®¡ç†å±‚ï¼šç³»ç»Ÿåº¦é‡ï¼ˆå¦‚åŸºç¡€è®¾æ–½ã€å®¹å™¨å’Œç½‘ç»œçš„åº¦é‡ï¼‰ï¼Œè‡ªåŠ¨åŒ–ï¼ˆå¦‚è‡ªåŠ¨æ‰©å±•ã€åŠ¨æ€ Provision ç­‰ï¼‰ä»¥åŠç­–ç•¥ç®¡ç†ï¼ˆRBACã€Quotaã€PSPã€NetworkPolicy ç­‰ï¼‰
- æ¥å£å±‚ï¼škubectl å‘½ä»¤è¡Œå·¥å…·ã€å®¢æˆ·ç«¯ SDK ä»¥åŠé›†ç¾¤è”é‚¦
- ç”Ÿæ€ç³»ç»Ÿï¼šåœ¨æ¥å£å±‚ä¹‹ä¸Šçš„åºå¤§å®¹å™¨é›†ç¾¤ç®¡ç†è°ƒåº¦çš„ç”Ÿæ€ç³»ç»Ÿï¼Œå¯ä»¥åˆ’åˆ†ä¸ºä¸¤ä¸ªèŒƒç•´
  - Kubernetes å¤–éƒ¨ï¼šæ—¥å¿—ã€ç›‘æ§ã€é…ç½®ç®¡ç†ã€CIã€CDã€Workflowã€FaaSã€OTS åº”ç”¨ã€ChatOps ç­‰
  - Kubernetes å†…éƒ¨ï¼šCRIã€CNIã€CVIã€é•œåƒä»“åº“ã€Cloud Providerã€é›†ç¾¤è‡ªèº«çš„é…ç½®å’Œç®¡ç†ç­‰



#### 2ï¼‰æ ¸å¿ƒç»„ä»¶

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/architecture/images/core-packages.png)

Kubernetes ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š

- etcd ä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼›
- kube-apiserverã€Master ç»„ä»¶ã€‘æä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€API æ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼›
- kube-controller-managerã€Master ç»„ä»¶ã€‘ è´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰ï¼›
  - èŠ‚ç‚¹æ§åˆ¶å™¨ï¼š è´Ÿè´£ç›‘å¬èŠ‚ç‚¹åœæœºçš„äº‹ä»¶å¹¶ä½œå‡ºå¯¹åº”å“åº”
  - å‰¯æœ¬æ§åˆ¶å™¨ï¼š è´Ÿè´£ä¸ºé›†ç¾¤ä¸­æ¯ä¸€ä¸ª å‰¯æœ¬æ§åˆ¶å™¨å¯¹è±¡ï¼ˆReplication Controller Objectï¼‰ç»´æŠ¤æœŸæœ›çš„ Pod å‰¯æœ¬æ•°
  - ç«¯ç‚¹ï¼ˆEndpointsï¼‰æ§åˆ¶å™¨ï¼šè´Ÿè´£ä¸ºç«¯ç‚¹å¯¹è±¡ï¼ˆEndpoints Objectï¼Œè¿æ¥ Service å’Œ Podï¼‰èµ‹å€¼
  - Service Account & Tokenæ§åˆ¶å™¨ï¼š è´Ÿè´£ä¸ºæ–°çš„åç§°ç©ºé—´åˆ›å»º default Service Account ä»¥åŠ API Access Token
- kube-schedulerã€Master ç»„ä»¶ã€‘ è´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°† Pod è°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šï¼›
- kubeletã€Node ç»„ä»¶ã€‘è´Ÿè´£ç»´æŒå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£ Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ï¼›
- Container runtimeã€Node ç»„ä»¶ã€‘ è´Ÿè´£é•œåƒç®¡ç†ä»¥åŠ Pod å’Œå®¹å™¨çš„çœŸæ­£è¿è¡Œï¼ˆCRIï¼‰ï¼Œé»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶ä¸º Dockerï¼›
- kube-proxyã€Node ç»„ä»¶ã€‘ è´Ÿè´£ä¸º Service æä¾› cluster å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼›

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/architecture/images/components.png)

é™¤äº†æ ¸å¿ƒç»„ä»¶ï¼Œè¿˜æœ‰ä¸€äº›æ¨èçš„ Add-onsï¼š

- kube-dns è´Ÿè´£ä¸ºæ•´ä¸ªé›†ç¾¤æä¾› DNS æœåŠ¡
- Ingress Controller ä¸ºæœåŠ¡æä¾›å¤–ç½‘å…¥å£
- Heapster æä¾›èµ„æºç›‘æ§
- Dashboard æä¾› GUI
- Federation æä¾›è·¨å¯ç”¨åŒºçš„é›†ç¾¤
- Fluentd-elasticsearch æä¾›é›†ç¾¤æ—¥å¿—é‡‡é›†ã€å­˜å‚¨ä¸æŸ¥è¯¢



#### 3ï¼‰æ ¸å¿ƒ API

Kubernetes [æ§åˆ¶é¢](https://kubernetes.io/zh/docs/reference/glossary/?all=true#term-control-plane) çš„æ ¸å¿ƒæ˜¯ [API æœåŠ¡å™¨](https://kubernetes.io/docs/reference/generated/kube-apiserver/)ã€‚ API æœåŠ¡å™¨è´Ÿè´£æä¾› HTTP APIï¼Œä»¥ä¾›ç”¨æˆ·ã€é›†ç¾¤ä¸­çš„ä¸åŒéƒ¨åˆ†å’Œé›†ç¾¤å¤–éƒ¨ç»„ä»¶ç›¸äº’é€šä¿¡ã€‚

Kubernetes API ä½¿ä½ å¯ä»¥æŸ¥è¯¢å’Œæ“çºµ Kubernetes API ä¸­å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼šPodã€Namespaceã€ConfigMap å’Œ Eventï¼‰çš„çŠ¶æ€ã€‚

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/architecture/images/core-apis.png)



#### 4ï¼‰ç”Ÿæ€ç³»ç»Ÿ

![](https://static.bookstack.cn/projects/feiskyer-kubernetes-handbook-202005/architecture/images/core-ecosystem.png)



## ä¸‰ã€Kubernetes éƒ¨ç½²

â€‹	å‚è€ƒ[Kubernetes The Hard Way](https://github.com/kelseyhightower/kubernetes-the-hard-way)ï¼šä»‹ç»äº†åœ¨  [Google Kubernetes Engine](https://cloud.google.com/kubernetes-engine)çš„ Ubuntu è™šæ‹Ÿæœºä¸­ä¸€æ­¥æ­¥éƒ¨ç½²ä¸€å¥— Kubernetes é«˜å¯ç”¨é›†ç¾¤çš„è¯¦ç»†æ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤ä¹ŸåŒæ ·é€‚ç”¨äº CentOS ç­‰å…¶ä»–ç³»ç»Ÿä»¥åŠ AWSã€Azure ç­‰å…¶ä»–å…¬æœ‰äº‘å¹³å°ã€‚



### 1.å•æœºéƒ¨ç½²

#### 1ï¼‰minikube

[minikubeå®˜ç½‘](https://minikube.sigs.k8s.io/docs/)

[kubernetes](https://github.com/kubernetes)/**[minikube](https://github.com/kubernetes/minikube)**

minikubeåœ¨macOSï¼ŒLinuxå’ŒWindowsä¸Šå®ç°äº†æœ¬åœ°Kubernetesé›†ç¾¤ã€‚minikubeçš„[ä¸»è¦ç›®æ ‡](https://minikube.sigs.k8s.io/docs/concepts/principles/)æ˜¯æˆä¸ºæœ¬åœ°Kubernetesåº”ç”¨ç¨‹åºå¼€å‘çš„æœ€ä½³å·¥å…·ï¼Œå¹¶æ”¯æŒæ‰€æœ‰åˆé€‚çš„KubernetesåŠŸèƒ½ã€‚

- minikubeæ”¯æŒæ ‡å‡†çš„KubernetesåŠŸèƒ½å¦‚ä¸‹ï¼š
  - [LoadBalancer-](https://minikube.sigs.k8s.io/docs/handbook/accessing/#loadbalancer-access)ä½¿ç”¨`minikube tunnel`
  - å¤šé›†ç¾¤-ä½¿ç”¨ `minikube start -p `
  - NodePorts-ä½¿ç”¨ `minikube service`
  - [æŒä¹…å·](https://minikube.sigs.k8s.io/docs/handbook/persistent_volumes/)
  - [å…¥å£](https://kubernetes.io/docs/tasks/access-application-cluster/ingress-minikube/)
  - [ä»ªè¡¨æ¿](https://minikube.sigs.k8s.io/docs/handbook/dashboard/) -`minikube dashboard`
  - [å®¹å™¨è¿è¡Œæ—¶](https://minikube.sigs.k8s.io/docs/handbook/config/#runtime-configuration) -`start --container-runtime`
  - é€šè¿‡å‘½ä»¤è¡Œæ ‡å¿—[é…ç½®apiserverå’Œkubeleté€‰é¡¹](https://minikube.sigs.k8s.io/docs/handbook/config/#modifying-kubernetes-defaults)

- ä»¥åŠå¼€å‘äººå‘˜å‹å¥½çš„åŠŸèƒ½ï¼š
  - [æ’ä»¶](https://minikube.sigs.k8s.io/docs/handbook/deploying/#addons) -å¼€å‘äººå‘˜å…±äº«minikubeä¸Šè¿è¡ŒæœåŠ¡çš„é…ç½®çš„å¸‚åœº
  - [NVIDIA GPUæ”¯æŒ](https://minikube.sigs.k8s.io/docs/tutorials/nvidia_gpu/) -ç”¨äºæœºå™¨å­¦ä¹ 
  - [æ–‡ä»¶ç³»ç»ŸæŒ‚è½½](https://minikube.sigs.k8s.io/docs/handbook/mount/)

#### 2ï¼‰å®‰è£…è¿‡ç¨‹

å®‰è£…å‰æ

- 2ä¸ªæˆ–æ›´å¤šCPU
- 2GBçš„å¯ç”¨å†…å­˜
- 20GBçš„å¯ç”¨ç£ç›˜ç©ºé—´
- ç½‘ç»œè¿æ¥
- å®¹å™¨æˆ–è™šæ‹Ÿæœºç®¡ç†å™¨ï¼Œä¾‹å¦‚ï¼š[Docker](https://minikube.sigs.k8s.io/docs/drivers/docker/)ï¼Œ[Hyperkit](https://minikube.sigs.k8s.io/docs/drivers/hyperkit/)ï¼Œ[Hyper-V](https://minikube.sigs.k8s.io/docs/drivers/hyperv/)ï¼Œ[KVM](https://minikube.sigs.k8s.io/docs/drivers/kvm2/)ï¼Œ[Parallels](https://minikube.sigs.k8s.io/docs/drivers/parallels/)ï¼Œ[Podman](https://minikube.sigs.k8s.io/docs/drivers/podman/)ï¼Œ[VirtualBox](https://minikube.sigs.k8s.io/docs/drivers/virtualbox/)æˆ–[VMWare](https://minikube.sigs.k8s.io/docs/drivers/vmware/)

```shell
# å®‰è£…kubectl
$ curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
$ kubectl version --client

# å®‰è£…Hypervisorã€VirtualBoxæˆ–QEMU

# äºŒè¿›åˆ¶ä¸‹è½½åŠå®‰è£…minikube
$ curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
$ sudo install minikube-linux-amd64 /usr/local/bin/minikube

# å¯åŠ¨é›†ç¾¤
$ minikube start
ğŸ˜„  minikube v1.12.3 on Ubuntu 16.04
âœ¨  Using the virtualbox driver based on existing profile
ğŸ‘  Starting control plane node minikube in cluster minikube
ğŸ”„  Restarting existing virtualbox VM for "minikube" ...
ğŸ³  Preparing Kubernetes v1.18.3 on Docker 19.03.12 ...
ğŸ”  Verifying Kubernetes components...
ğŸŒŸ  Enabled addons: default-storageclass, storage-provisioner
ğŸ„  Done! kubectl is now configured to use "minikube"

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured
```

